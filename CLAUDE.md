# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

**dear-applicant** is a full-stack React Router v7 application deployed on Cloudflare Workers. It's a kanban-style job application tracker. Uses SSR, Vite for builds, and TailwindCSS v4 for styling. Auth via better-auth, database via Drizzle ORM + Cloudflare D1.

## Commands

```bash
pnpm dev              # Dev server with HMR at http://localhost:5173
pnpm build            # Production build (runs react-router build)
pnpm test             # Run Vitest unit tests
pnpm preview          # Preview production build locally
pnpm deploy           # Build + deploy to Cloudflare Workers
pnpm typecheck        # TypeScript checking + React Router typegen
pnpm cf-typegen       # Generate Cloudflare Workers types
```

No linter is configured yet.

## Architecture

### Request Flow
Cloudflare Worker (`workers/app.ts`) → React Router request handler → SSR via `app/entry.server.tsx` → Route loaders/components

### Key Files
- `workers/app.ts` — Worker entry point; creates React Router handler and provides Cloudflare context (`env` + `ExecutionContext`) via `AppLoadContext`
- `app/entry.server.tsx` — Server rendering with React 19 streaming (`renderToReadableStream`); uses `isbot` to detect bots and await full render
- `app/root.tsx` — Root layout with global error boundary
- `app/routes.ts` — Route configuration (React Router v7 `RouteConfig` pattern)
- `wrangler.jsonc` — Cloudflare Workers config (nodejs_compat enabled, observability on)

### Path Alias
`~/` maps to `./app/` (configured in `tsconfig.cloudflare.json`)

### TypeScript
Three tsconfig files: root (`tsconfig.json`), app (`tsconfig.cloudflare.json`), and build tools (`tsconfig.node.json`). Strict mode is enabled. React Router typegen produces types in `.react-router/types/`.

### Styling
TailwindCSS v4 with `@import` syntax in `app/app.css`. Inter font from Google Fonts. Dark mode via `prefers-color-scheme`.

### Database & Auth
- **D1 binding:** `dearapplicant` (configured in `wrangler.jsonc`)
- **Drizzle config:** `drizzle.config.ts` — points to both `app/db/schema.ts` and `app/db/auth-schema.ts`
- **DB singleton:** `app/db/index.ts` — uses `import { env } from "cloudflare:workers"` for top-level D1 access
- **Auth singleton:** `app/lib/auth.ts` — better-auth with Drizzle adapter (SQLite provider)
- **Auth schema:** `app/db/auth-schema.ts` — `user`, `session`, `account`, `verification` tables (written manually; better-auth CLI can't resolve `cloudflare:workers` imports)
- **App schema:** `app/db/schema.ts` — `boardColumn`, `application`, `contact`, `columnTransition` tables
- **Migrations:** `drizzle/migrations/` — generated by `npx drizzle-kit generate`, applied with `npx wrangler d1 migrations apply dearapplicant`
- No hardcoded status enum — an application's status is determined by which `boardColumn` it belongs to

### Schema Workflow
1. Edit schema files in `app/db/`
2. `npx drizzle-kit generate` → new migration file
3. `npx wrangler d1 migrations apply dearapplicant` → apply to D1 (add `--local` for local dev)

Local migrations must be applied after cloning or whenever new migration files are generated. Wrangler tracks applied migrations, so only new ones run.

### Cloudflare Environment
- Environment variables accessed in loaders via `context.cloudflare.env`
- Worker types generated by `wrangler types` (runs on `postinstall`)
- Both `db` and `auth` use `import { env } from "cloudflare:workers"` as module-level singletons — no need to thread D1 through `AppLoadContext`
- Secrets and per-environment config (OAuth client IDs, API keys) go in `.dev.vars` for local dev and Cloudflare dashboard for production — never commit them to `wrangler.jsonc`

## Code Conventions

### Auth routes
- Every public auth page (`login`, `signup`, `forgot-password`, `reset-password`) must have a loader that checks `getOptionalSession` and redirects logged-in users to `/dashboard`
- Always check the return value of better-auth client methods (`result.error`) — do not discard the result and assume success
- Use `React.FormEvent<HTMLFormElement>` for form submit handlers, not `React.SubmitEvent`

### HTML email templates
- All interpolated values in HTML email templates must be escaped with `escapeHtml()` — both `href` attributes and text content — to handle `&` in query params

### Config files
- `drizzle.config.ts` `dbCredentials.url` is a placeholder — each developer substitutes their own local D1 UUID path
- Use `<Link>` for navigation, not `useNavigate` + `<button>`, for consistency and accessibility
